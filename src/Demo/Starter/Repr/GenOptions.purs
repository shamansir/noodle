module StarterTk.Repr.GenOptions where

import Prelude

import Data.Maybe (Maybe(..))

import Type.Proxy (Proxy(..))

import Partial.Unsafe (unsafePartial)

import Tidy.Codegen (declImport, declImportAs, importOp, importType, importTypeOp, importValue, importTypeAll)

import Noodle.Id (family) as Id
import Noodle.Fn.Shape.Temperament (defaultAlgorithm) as Temperament
import Noodle.Text.NdfFile.FamilyDef.Codegen (Options(..), familyPascalCase, groupPascalCase)
import Noodle.Text.NdfFile.Codegen (toolkitModuleName) as CG

import StarterTk.Repr.StRepr (StateRepr)
import StarterTk.Repr.ChRepr (ValueRepr)


genOptions :: Options StateRepr ValueRepr
genOptions = Options $
    { streprAt : { module_ : "StarterTk.Repr.StRepr", type_ : "StateRepr" }
    , chreprAt : { module_ : "StarterTk.Repr.ChRepr", type_ : "ValueRepr" }
    , temperamentAlgorithm : Temperament.defaultAlgorithm
    , monadAt : { module_ : "Effect", type_ : "Effect" }
    , familyModuleName : \fgroup family -> "StarterTk" <> "." <> "Gen" <> "." <> "Library" <> "." <> groupPascalCase fgroup <> "." <> familyPascalCase family
    , toolkitModuleName : CG.toolkitModuleName
    , pstrepr : (Proxy :: _ StateRepr)
    , pchrepr : (Proxy :: _ ValueRepr)
    , infoComment : Just $ \mbSource fgroup family ->
            "Generated by Noodle Codegen from NDF file. Group :: " <> show fgroup <> ". Family :: " <> show family <> "." <> case mbSource of
            Just src -> "\n\n[[ " <> src.line <> " ]] (#" <> show src.lineIndex <> ")"
            Nothing -> ""
    , tkImports : genericImports
    , familyImports : \familyR ->
        genericImports <> case Id.family familyR of
            "gennum" ->
                unsafePartial $
                    [ declImport "Data.Maybe" [ importTypeAll "Maybe" ]
                    , declImport "Data.Newtype" [ importValue "unwrap", importValue "wrap" ]
                    , declImport "Effect.Class" [ importValue "liftEffect" ]
                    , declImport "Effect.Random" [ importValue "random" ]
                    , declImportAs "Control.Monad.State" [ importValue "get", importValue "modify_" ] "State"
                    , declImport "Signal" [ importOp "~>", importType "Signal" ]
                    , declImportAs "Signal" [ importValue "runSignal" ] "Signal"
                    , declImportAs "Signal.Extra" [ ] "SignalX"
                    , declImportAs "Signal.Time" [ importValue "every" ] "Signal"
                    ]
            "metro" ->
                unsafePartial $
                    [ declImport "Data.Maybe" [ importTypeAll "Maybe" ]
                    , declImportAs "Data.Int" [ importValue "toNumber" ] "Int"
                    , declImport "Data.Newtype" [ importValue "unwrap", importValue "wrap" ]
                    , declImportAs "Control.Monad.State" [ importValue "get", importValue "put" ] "State"
                    , declImportAs "Signal.Time.Extra" [ importValue "every" ] "SignalX"
                    , declImportAs "Signal" [ importValue "runSignal" ] "Signal"
                    , declImport "Signal" [ importOp "~>" ]
                    ]
            _ -> []
    }
    where
        genericImports = unsafePartial $
            [ declImportAs "StarterTk.Repr.ChRepr" [] "VR"
            , declImport "Data.Tuple.Nested" [ importOp "/\\", importTypeOp "/\\" ]
            ]
